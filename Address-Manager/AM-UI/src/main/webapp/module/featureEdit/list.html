<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>首页</title>
    <link href="css/index.css" rel="stylesheet">
    <link href="css/ld.css" rel="stylesheet">
    <link href="css/font.css" rel="stylesheet">
    <link href="css/bootstrap-dialog.min.css" rel="stylesheet">
    <link href="css/bootstrap-select.min.css" rel="stylesheet">
    <style>
        .popup-content .markadd input, .popup-content .markadd textarea {
            width: 310px;
            border-radius: 6px;
            line-height: 30px;
            box-sizing: border-box;
            border: 1px solid #ccc;

        }
        .popup-content .markadd input {
            height: 30px;
            margin-top:11px;
        }
        .popup-content .markadd textarea {
            height: 60px;
            margin-top:21px;
        }
        .popup-poi-template .title .toolbar {
            color:#5595DC;
        }
        .popup-markadd-content>div{
            width: 100%;
        }
        .popup-markadd-content .mark-add-label {

        }
        .mark-add-isAdd span {
            float: right;
            font-size: 14px;
            font-weight: 800;
            margin-right: 10px;
        }

    </style>
</head>
<body>
    <div id="simpleMap"></div>
    <div id="searchBox" class="searchbox no4j kwai no4jShadow">
        <div id="putCX" style="margin: 10px 3px; display: block;">
            <!-- 下拉菜单 -->
            <span class="f_left"> <!-- <input type="hidden" class="" id="region" />	 -->
                <div class="btn-group bootstrap-select" style="width: 100px;">
                    <button id="roleBtn" type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="region" title="全区"><span class="filter-option pull-left">请选择</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open" style="">
                    <ul class="dropdown-menu inner" role="menu" style="" id="roleUL">
                        <!--<li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全区</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="1"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">大沥镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="2"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">丹灶镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="3"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">桂城街道</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="4"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">九江镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="5"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">里水镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="6"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">狮山镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>
                        <li data-original-index="7"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">西樵镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>-->
                    </ul>
                </div>
                    <select class="selectpicker" data-width="100px" id="region" tabindex="-98">
                        <!--<option value="">全区</option><option value="440605125">大沥镇</option><option value="440605123">丹灶镇</option><option value="440605001">桂城街道</option><option value="440605121">九江镇</option><option value="440605126">里水镇</option><option value="440605124">狮山镇</option><option value="440605122">西樵镇</option>-->
                    </select></div>&nbsp;
                <div class="btn-group bootstrap-select" style="width: 100px;">
                    <button id="roleCityBtn" type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="region" title="全区"><span class="filter-option pull-left">请选择</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open" style="">
                    <ul class="dropdown-menu inner" role="menu" style="" id="roleCityUL">
                    </ul>
                </div>
                    <select class="selectpicker" data-width="100px" id="regionCity" tabindex="-98"></select></div>
			</span>
            <div class="kj1_all_long">
                <input type="text" class="f_left kj1_i_long" id="keywords" style="width: 263px; margin-left: 15px;" placeholder="可输入名称、地址"> <input type="submit" class="f_left kj1_i2" id="searchBtn" value="">
                <p class="f_left" id="Gjcx" style="margin-left: 10px; font-weight: bold">显示列表</p>
            </div>
        </div>
        <div class="mb20" id="gjCX1" style="width: 100%; display: none;">
            <div class="GJCXrows" style="width: 100%; height: 35px; margin: 10px">
                <input type="text" class="f_left kj1_i_long" id="hkeywords" placeholder="可输入名称、地址" style="width: 470px;"> <input type="submit" class="f_left kj1_i2" id="input1" value="" onclick="searchUserList(1)" style=""> <span class="fanhui2" id="fanhui" style="">返回</span>
            </div>
        </div>
        <div class="sch_header" style="margin-bottom: 2px;" id="sch_header">
            <div class="kj9_rb o_hidden f_left"><input id="modalType" type="hidden" />
                <a href="#" class="kj9_rb1 kj9_rba f_left" data-toggle="modal" data-target="#myModal" id="addMzInfo">新增</a>
                <a href="#" class="kj9_rb2 kj9_rba f_left" data-toggle="modal" data-target="#myModal" id="updateMzInfo">编辑</a><input type="hidden" id="mz_ID"/>
                <a href="#" class="kj9_rb3 kj9_rba f_left" id="deleteInfo">删除</a>
                <!-- <a href="#" class="kj9_rb4 kj9_rba f_left" onclick="exportMzInfo()" id="exportMzInfo">导出</a> -->
            </div>
            <h3 class="f_right" style="display: none;">
                搜索到<span id="pcount"></span>条结果
            </h3>
        </div>
        <div id="addrTable_div" style="display: none;" class="ld_gridContrainer">
            <!--<table id="addrTable"></table>-->
            <table id="addrTable" style="display: none;" data-cache="false" data-click-to-select="true" data-single-select="true" data-striped="true" data-only-info-pagination="true" data-show-header="true">
                <thead>
                <tr>
                    <th data-field="state" data-checkbox="true" data-cell-style="hideCell" data-visible="true"  data-width="5%"></th>
                    <th data-align='center' data-formatter="indexFormatter" data-width="10%">序号</th>
                    <th data-field="adcode" data-align='center' data-width="25%">行政编码</th>
                    <th data-field="address" data-align='center' data-width="50%">地址</th>
                    <!-- <th data-field="svMark" data-align='center' data-formatter="svMark_bstformat" data-width="10%">全景</th> -->
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <div id="popup12" class="popup-poi-template" style="width: 350px;">
        <div class="title">
            <div style="position: relative; height: 33px; z-index: 1; white-space: nowrap; color: rgb(124, 112, 112); font-weight: bold; font-size: 12px; line-height: 33px; margin: 0px 6px; padding-left: 6px; /*border-bottom: 1px dashed rgb(215, 215, 215);*/">
                <div>
                    <div class="popup-title" style="width: 220px;text-overflow: ellipsis;overflow: hidden;"></div>
                </div>
            </div>
            <!--<div class="toolbar" style="position: absolute; right: 34px; top: 0px; z-index: 1000;height: 100%;display: flex;align-items: center">
                <div class="toolbar-content" style="float: right">
                    <span class="favcls icon-shoucang2"
                          style="font-size: 20px;"
                          title="收藏"></span>
                    <div id="editTool" style="display: inline-block">

                        <img id="featureEdit" src="img/feature_edit.png"
                             style="box-sizing: content-box; cursor: pointer;width: 15px;height: 15px;padding-right: 6px;padding-left:7px;border-right: 1px solid #CAC5C2;border-left: 1px solid #CAC5C2"
                             class="featureEdit" title="编辑"/>

                        <img src="img/delete-poi.png"
                             style="box-sizing: content-box; cursor: pointer;width: 16px;height: 16px;margin: 0 3px"
                             class="deletePoi" id="deletePoi" title="删除">
                    </div>
                </div>
            </div>-->
            <a style="cursor: pointer; position: absolute; width: 24px; height: 24px; right: 2px;top: 5px;z-index: 100"
               title="关闭" class="popup-close">
                <img src="img/icon-close1.png" style=" cursor: pointer">
            </a>
        </div>

        <div style="position: absolute; z-index: 3; left: 152px; bottom: 0;">
            <div style="position: absolute; overflow: hidden; width: 45px; height: 27px;"><img
                    src="img/overlay-icon1.png"
                    style="width: 45px; height: 27px; position: absolute; left: 0px; top: 0px; z-index: 0; -moz-user-select: none; border: 0px none;"></div>
        </div>
        <div style="background-color: rgb(255, 255, 255); overflow: hidden; display: block;padding: 10px;border-bottom-right-radius: 5px;border-bottom-left-radius: 5px;">
            <div class="popup-content">
            </div>
            <!--<div class="poi-popup-near" id="poi-popup-near-id">
                <div class="search-input">
                    <a class="searchBtn"  >
                        <span class="icon-fenxiang1" style="margin: 6px 11px 6px 11px;font-size: 18px;color: #fff"></span>
                    </a>
                    <input type="hidden" class="popup_poi_geometry">
                    <input type="hidden" class="popup_isFavoritePOI">
                    <div style=" box-shadow: none;">
                        <span>周边搜索:</span>
                        <input type="text" style="width: 205px;" class='popup-nearby-keyword' v-model="nearByKeyword" placeholder="请输入周边查询关键字"/>
                    </div>
                </div>
                <ul class="poi-popup-near-type">
                </ul>
            </div>-->
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" style="display: none;">
        <div class="modal-dialog" style="height:1000px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title" id="addModalLabel">名址新增</h4>
                    <!--<input id="modalType" style="display:none">-->
                    <input id="id" style="display:none" attr="attr">
                </div>
                <div class="modal-body">
                    <table id="hm-EditTbl" class="ld-vm-editTb">
                        <tbody id="chakan">
                        <td class="csw_30 t_a_r cs_pad_r_10">级别：</td>
                            <td>
                                <div style="width:100%;height:56px">
                                    <span></span> <span class="f_left" style="margin:10px 0px;"> <input type="hidden" class="" id="levelID_ld" /> <input type="hidden" class="" id="adcodeID_ld" />
                                    <div class="btn-group bootstrap-select" style="width: 180px;">
                                        <!--<<select class="form-control" data-width="180px" id="pre_adCode" attr="attr" onchange="addrChange()" tabindex="-98"><option value="">全区</option><option value="440605125">大沥镇</option><option value="440605123">丹灶镇</option><option value="440605001">桂城街道</option><option value="440605121">九江镇</option><option value="440605126">里水镇</option><option value="440605124">狮山镇</option><option value="440605122">西樵镇</option></select>-->
                                        <button id="levelDropdownBtn" type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="levelID_ld" title=""><span class="filter-option pull-left"></span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button>
                                        <div class="dropdown-menu open" id="levelDropdownContainer" style="">
                                            <ul class="dropdown-menu inner" role="menu" id="levelDropdownUl" style="height: 275px; overflow-y: auto;">
                                                <!--<li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全区</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li>-->
                                            </ul>
                                        </div>
                                        <select class="selectpicker" data-width="180px" id="pre_adCode" attr="attr" onchange="addrChange()" tabindex="-98"><option value="">全区</option><option value="440605125">大沥镇</option><option value="440605123">丹灶镇</option><option value="440605001">桂城街道</option><option value="440605121">九江镇</option><option value="440605126">里水镇</option><option value="440605124">狮山镇</option><option value="440605122">西樵镇</option></select></div>
                                    </span> <span></span>
                                    <!--<span class="f_left" style="margin:10px auto 5px 10px;"> <input type="hidden" class="" id="adCode" /><div class="btn-group bootstrap-select" style="width: 180px;">
                                    <button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="adCode" title="全部"><span class="filter-option pull-left">全部</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open"><ul class="dropdown-menu inner" role="menu"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全部</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div><select class="selectpicker" data-width="180px" id="adCode" name="required" attr="attr" onchange="addrChange()" tabindex="-98"><option value="">全部</option></select></div>
											</span>-->
                                </div>
                                <p class="inp_text d_none" id="levelId_warn" style="display: none;">这是必填字段！</p>
                                <!--<p class="inp_text d_none">这是必填字段！</p>-->
                            </td>
                        </tr>
                        <tr>
                            <td class="csw_30 t_a_r cs_pad_r_10"><font style="color:red">*</font>行政区划：</td>
                            <td>
                                <div style="width:100%;height:56px">
                                    <input name="required" id="addressGi" type="text" class="form-control" readonly="" attr="attr" style="width: 200px; display: inline-block;">
                                    <input type="text" id="address_extent" class="form-control" style="width: 180px; display: inline-block;"/>
                                    <!--<span></span> <span class="f_left" style="margin:10px 0px;">  <input type="hidden" class="" id="pre_adCode" />
                                    <div class="btn-group bootstrap-select" style="width: 180px;">-->
                                        <!--<<select class="form-control" data-width="180px" id="pre_adCode" attr="attr" onchange="addrChange()" tabindex="-98"><option value="">全区</option><option value="440605125">大沥镇</option><option value="440605123">丹灶镇</option><option value="440605001">桂城街道</option><option value="440605121">九江镇</option><option value="440605126">里水镇</option><option value="440605124">狮山镇</option><option value="440605122">西樵镇</option></select>-->
                                    <!--<button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="pre_adCode" title="全区"><span class="filter-option pull-left">全区</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button>
                                    <div class="dropdown-menu open"><ul class="dropdown-menu inner" role="menu"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全区</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="1"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">大沥镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="2"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">丹灶镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="3"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">桂城街道</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="4"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">九江镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="5"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">里水镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="6"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">狮山镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="7"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">西樵镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div>
                                    <select class="selectpicker" style="display: none;" data-width="180px" id="pre_adCode" attr="attr" onchange="addrChange()" tabindex="-98"><option value="">全区</option><option value="440605125">大沥镇</option><option value="440605123">丹灶镇</option><option value="440605001">桂城街道</option><option value="440605121">九江镇</option><option value="440605126">里水镇</option><option value="440605124">狮山镇</option><option value="440605122">西樵镇</option></select></div>
                                        </span> <span></span> <span class="f_left" style="margin:10px auto 5px 10px;">  <input type="hidden" class="" id="adCode" />  <div class="btn-group bootstrap-select" style="width: 180px;"><button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="adCode" title="全部"><span class="filter-option pull-left">全部</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open"><ul class="dropdown-menu inner" role="menu"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全部</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div>
                                    <select class="selectpicker" data-width="180px" id="adCode" name="required" attr="attr" onchange="addrChange()" tabindex="-98" style="display: none;"><option value="">全部</option></select></div>
											</span>-->
                                </div>
                                <p class="inp_text d_none" id="adCode_warn" style="display: none;">这是必填字段！</p>
                            </td>
                        </tr>
                        <tr>
                            <td class="csw_30 t_a_r cs_pad_r_10"><font style="color:red">*</font>类别：</td>
                            <td>
                                <div class="btn-group bootstrap-select" style="width: 180px;">
                                    <button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="pre_adCode" title="全区"><span class="filter-option pull-left"></span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button>
                                    <div class="dropdown-menu open" style="height: 176.2px; width: 180px; ">
                                        <div id="tab_container" style="height: 140px; overflow-y: auto;">
                                            <input type="hidden" id="typeID_ld"/>
                                            <table id="poiTypeTable" data-cache="false" data-click-to-select="true" data-single-select="true" data-striped="true" data-only-info-pagination="true" data-show-header="true">
                                                <thead>
                                                <tr>
                                                    <th data-field="typeName" data-align='center' data-width="100%">名称</th>
                                                    <!-- <th data-field="svMark" data-align='center' data-formatter="svMark_bstformat" data-width="10%">全景</th> -->
                                                </tr>
                                                </thead>
                                            </table>
                                        </div>
                                        <div id="tab_pagation" style="height: 36.2px; border-top: 1px solid #ddd;"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="csw_30 t_a_r cs_pad_r_10">详细地址：</td>
                            <td><input id="address" type="text" class="form-control" value=""  attr="attr" readonly>
                            <p class="inp_text d_none" id="address_warn" style="display: none;">这是必填字段！</p></td>
                        </tr>
                        <tr>
                            <td class="csw_30 t_a_r cs_pad_r_10"><font style="color:red">*</font>坐标：</td>
                            <td>
                                <div class="input-group" style="width:371px">
                                    <input name="required" id="shape" type="text" class="form-control" readonly="" attr="attr"> <span id="poiSpan" class="input-group-addon zuobiao" style="color: #337ab7; cursor: pointer;"> <span class="glyphicon glyphicon-record"></span></span>
                                </div>
                                <p class="inp_text d_none" id="shape_warn" style="display: none;">这是必填字段！</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <p id="_submit_warn" style="color:red;display:none;margin-left:158px">提交失败,请重新提交!</p>
                </div>
                <div class="modal-footer">
                    <button id="mz_smt" type="button" class="btn btn-primary">提交</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="js/bootstrap-table.js"></script>
<script src="js/bootstrap-dialog.js"></script>
<script src="js/ldmz.dialog.js"></script>
<script src="js/map/styleManager.js"></script>
<script src="js/map/MapView.js"></script>
<script src="js/map/featureManager.js"></script>
<script src="js/map/popup.js"></script>
<script id="_templatePopInfo" type="text/html">
    <ul>
        <!-- for: {{{attrs}}} as {{{poiValue}}}, {{{poiKey}}} -->
        <li>{{{poiKey}}}: {{{poiValue}}}</li>
        <!-- /for -->
    </ul>
</script>
<script>
    require(["etpl"], function (etpl) {
        !baseMap.map&& baseMap.initMap({"el": "simpleMap"});
        var map = baseMap.map,
            vector = baseMap.vector,
            draw = baseMap.draw,
            popup = popupManager.init({"map": map});

        $("#searchBox").off("click").on("click", "#Gjcx", function(){
            var $dom = $("#addrTable_div");
            $dom.attr("isloaded")? ($dom.toggle(), $dom.is(":visible")? $(this).text("隐藏列表"): $(this).text("显示列表")): bootstrapDialog("warning", "列表尚未加载,没有可显示的内容!").open();;
        }).on("click", "#searchBtn", function () {
            searchList();
        }).on("click", "#roleUL>li", function(){
            var $this = $(this),
                $idx = $this.index(),
                $txt = $this.data("text"),
                $val = $this.data("value");
            $idx ===0? $("#ld_adcodeHid").val(""): $("#ld_adcodeHid").val($val);
            $("#roleBtn span.filter-option.pull-left").text($txt);
            $.get("rest/region/district1?adcode="+$val+"&level=2").done(function(data){
                var html = [];
                data = data["content"];
                data.forEach(function(item, i){
                    html.push("<li data-original-index=\""+i+"\" data-value='"+item["code"]+"' data-text='"+item["name"]+"'><a tabindex='"+i+"' class=\"\" style=\"\" data-tokens=\"\"><span class=\"text\">"+item["name"]+"</span><span class=\"glyphicon glyphicon-ok check-mark\"></span></a></li>");
                });
                $("#roleCityUL").empty().html(html.join("")).on("click", "li", function(){
                    var $_val = $(this).data("value"), $_idx = $(this).index(), $_txt = $(this).data("text");
                    $_idx ===0? $("#ld_adcodeHid").val(""): $("#ld_adcodeHid").val($_val);
                    $("#roleCityBtn span.filter-option.pull-left").text($_txt);
                });
            });
        });
        $("#addModal").on("click", "#poiSpan", function(){
            $("#addModal").modal("hide");
            draw.setActive(true);
        }).on("click", "#tab_pagation", function(){
            var $boots = $(this).closest("div.btn-group.bootstrap-select");
            $boots.addClass("open");
            return false;
        });
        $("#address_extent").on("input propertychange", function(){
            var $val = $(this).val();
            $("#address").val($("#addressGi").val()+$val)
        });
        var getAddrList_url = "rest/address/getAddrList";
        var addrTb;
        function searchList() {
            $("#addrTable").closest("div.ld_gridContrainer").attr("isloaded", true).end().show().bootstrapTable({
                "url": getAddrList_url,
                "method": "post",
                pageSize: 10,
                "dataKey": "rows",
                "silent": false,
                pagination: true,
                "singleSelect": true,
                "clickToSelect": true,
                "sidePagination": "server",
                "uniqueId": "id",
                "responseHandler": function(data){
                    return {"list": data["content"]["list"], "total": data["content"]["total"]};
                },
                "queryParams": function (bstparams) {
                    var params = {pageSize:10,pageNum: this.pageNumber};
                    if($("#keywords").val()){ params["name"] = $("#keywords").val();};
                    if($("#ld_adcodeHid").val()){ params["adcode"] = $("#ld_adcodeHid").val();};
                    return params;
                },
                "onLoadSuccess": function (result) {  //加载成功时
                    $("#img").hide();
                    $("#addrTable").prev("div.fixed-table-loading").hide();
                    $("#Gjcx").text("隐藏列表");
                    $("#sch_header h3.f_right").show();
                    $('#addrTable_div').show();
                    $('#mytablebutton1').show();
                    $('#pageul').show();
                    $("#pcount").text(result.total);
                    $("#addrTable").on("click", "tr", function(){
                        var $this = $(this);
                        $id = $this.attr("id");
                        var f = showPopupOnMap($id);
                        if(f){
                            setSelectFeatureStyle(f);
                            PopupInfo.showPopup(f);
                        };
                    });
                    addFeaturesOnMap(result["list"]);
                    //显示地图气泡
                    /*if(showSymbolCall!=undefined){
                 for(var i=0;i<(result.rows).length;i++){
                 (result.rows)[i].realMark="mark";
                 }
                 //showSymbolCall(result.rows);
                 }*/
            },
                "onPageChange": function(){
                $("#img").show();
            }
        });
    };

        var etplEngine = new etpl.Engine({
            variableOpen: "{{{",
            variableClose: "}}}"
        });
        //浮云框
        var PopupInfo = {
            //电子地图编辑
            initEvent:function(){
                $("#featureEdit").off("click").on("click",function(){
                    featureEdit.skipToFeatureEditActivity(currentSelectedFeature,1);
                    $(".popup-close").trigger("click");
                })
            },
            _showPopupCallback: function (feature) {
                setSelectFeatureStyle(feature);
                $(popup.getElement()).find(".popup-close").off().on("click", function () {
                    var closeEvt = arguments[0];
                    //还原被点击的图标样式
                    feature.setStyle(
                        poiSvgStyle({value: feature.getProperties().index})
                    )
                    popup.setPosition(undefined);
                    var mapBrowserEvent = new ol.MapBrowserEvent("singleclick", map, closeEvt);
                    ////取消要素点击
                    baseMap.selectSingleClick.handleEvent(mapBrowserEvent);

                    return false;
                });
                $(".popup_poi_geometry").attr("geometry", feature.getGeometry().getCoordinates().toString());
                var properties = feature.getProperties();
                if (properties.hasOwnProperty("isFavorite")) {
                    if (!properties.isFavorite) {
                        //改变伪元素样式
                        $(".favcls").removeClass("icon-shoucangxuanzhong").addClass("icon-shoucang2");
                    } else {
                        $(".favcls").removeClass("icon-shoucang2").addClass("icon-shoucangxuanzhong");
                    }
                }

                var properties = feature.getProperties();
                var addFeatrueInfo = function (info) {
                    $(popup.getElement()).find(".popup-content").html(info);
                };
                var getPros = function (pros) {
                    /*var _ServerToClientFields = pros.fieldAliases;
                    var showFields = pros.showFields;
                    var properties = {};
                    for(var key in _ServerToClientFields){
                        var _alias  = _ServerToClientFields[key]["alias"];
                        var key2  = _ServerToClientFields[key]["key"]
                        //如果后台别名项没有填值，则前端就使用默认字段名称显示
                        if(_alias === "") {
                            _alias  = key2;
                        }

                        if(_alias != "" && _alias != undefined) {
                            for(var i = 0;i < showFields.length;i++) {
                                if(showFields[i][key2]) {
                                    properties[_alias] = pros[key2]
                                }
                            }
                        }
                    };*/
                    var properties = {};
                    for(var k in pros){
                        if(pros.hasOwnProperty(k)&& k != "geometry"){
                            properties[k] = pros[k];
                        }
                    }
                    return properties;
                };
                var pros = getPros(properties);
                var popupTemplate = etplEngine.compile($("#_templatePopInfo").html());
                var pouptemlate = popupTemplate({attrs: pros});
                addFeatrueInfo(pouptemlate); //在popup中加载当前要素的具体信息
                $(popup.getElement()).find(".popup-title").text(pros["name"]).attr("title", pros["name"]);
            },
            showPopup: function (feature) {
                var props = feature.getProperties();
                if (feature && !props.feature_mark) {
                    popup.showPopup(feature, PopupInfo._showPopupCallback);
                }else {

                }
            },
            clickpoiCallback: function (evt) {
                var feature = evt.selected[0];
                if (feature) {
                    popup.showPopup(feature, PopupInfo._showPopupCallback);
                }
            }
        };

     PopupInfo.initEvent();
    $.get("rest/address/getLevel", function(data){
        var data = data["content"];
        if(data&& $.isArray(data)&& data["length"]){
            var html = [];

            data.forEach(function(item, i){
                html.push("<li data-original-index=\""+i+"\" data-value='"+item["levelValue"]+"' data-text='"+item["levelName"]+"'><a tabindex='"+i+"' class=\"\" style=\"\" data-tokens=\"\"><span class=\"text\">"+item["levelName"]+"</span><span class=\"glyphicon glyphicon-ok check-mark\"></span></a></li>");
            });
            $("#levelDropdownUl").empty().html(html.join(""));
            $("#levelDropdownUl li").on("click", function(){
                var name = $(this).data("text"), value = $(this).data("value");
                $("#levelDropdownBtn span.filter-option").text(name);
                $("#levelID_ld").val(value);
            });
        };
    });
    $.get("rest/region/district1").done(function(data){  debugger;
        var html = [];
        data = data["content"];
        data.forEach(function(item, i){
            html.push("<li data-original-index=\""+i+"\" data-value='"+item["code"]+"' data-text='"+item["name"]+"'><a tabindex='"+i+"' class=\"\" style=\"\" data-tokens=\"\"><span class=\"text\">"+item["name"]+"</span><span class=\"glyphicon glyphicon-ok check-mark\"></span></a></li>");
        });
        $("#roleUL").empty().html(html.join(""));
    });

     var setSelectFeatureStyle = function (feature) {
         if (currentSelectedFeature) {
             currentSelectedFeature.setStyle(
                    poiSvgStyle({value: currentSelectedFeature.getProperties().index})
                )
            }
            feature.setStyle(
                poiSvgStyle({value: feature.getProperties().index, on: true})
            )
         if (feature) {
             currentSelectedFeature = feature;
         }
     };

     var extent, currentSelectedFeature;
     function   addFeaturesOnMap(data){
        if(!data){
            throw new Error("invoid input arguments");
            return;
        };
        var features = [];

        if($.isArray(data)&& data["length"]){
            data.forEach(function(d, i){
                var feature1 = new ol.Feature({
                    'geometry': new ol.geom.Point(
                        [d.x, d.y])
                });
                var attributes = {"name": d["name"], "address": d["address"], "adCode": d["adcode"], "index": i+1, "id": d["id"], "type": d["type"]};
                feature1.setProperties(attributes);
                var ext = feature1.getGeometry().getExtent();
                if (extent) {
                    ol.extent.extend(extent, ext);
                } else {
                    extent = ext;
                };
                feature1.setStyle(poiSvgStyle({value: attributes.index }));
                features.push(feature1);
            });
            if (extent) {
                map.getView().fit(extent, map.getSize());
            };
            var featureManager = new FeatureManager(map, vector);
            featureManager.clearAll();
            featureManager.addFeatures(features);
        }
     };
     baseMap.selectSingleClick.on('select', PopupInfo.clickpoiCallback);

     function showPopupOnMap(idAttr){
         var features = vector.getSource().getFeatures(), feature;
         if(features&& features["length"]){
             features.forEach(function(f){
                var propertites = f.getProperties();
                var id = propertites["id"];
                if(id&& id == idAttr){
                    feature = f;
                    return false;
                };
             });
         };
         return feature;
     };



        $("#poiTypeTable").bootstrapTable({
            "url": "rest/address/getPoiType",
            pageSize: 10,
            uniqueId: "typeValue",
            "method": "post",
            "silent": false,
            pagination: true,
            "sidePagination": "server",
            "queryParams": function (bstparams) {
                var params = [];
                params.push({pageSize:10,pageNum: this.pageNumber});
                //$.extend(bstparams, []);
                return params;
            },
            "responseHandler": function(data){
                return {"list": data["content"]["list"], "total": data["content"]["total"]};
            },
            "onLoadSuccess": function (result) {  //加载成功时
                var $paginationDom = $("#poiTypeTable").parent().siblings("div.fixed-table-pagination"),
                    $paginationDomClone = $paginationDom.clone(true);
                $("#poiTypeTable").prev("div.fixed-table-loading").hide();
                $("thead", "#poiTypeTable").hide();
                $paginationDomClone.appendTo($("#tab_pagation").empty()).find("div.pagination-detail").hide();
                $paginationDom.hide().find("div.pagination-detail").hide();
                $("#poiTypeTable").on("click", "tr", function(){
                    var $value = $(this).attr("id"), $text = $("td", this).text();
                    $("#poiTypeTable").closest("div.dropdown-menu").prev("button").find("span.filter-option").text($text);
                    $("#typeID_ld").val($value);
                });
                //显示地图气泡
                /*if(showSymbolCall!=undefined){
                 for(var i=0;i<(result.rows).length;i++){
                 (result.rows)[i].realMark="mark";
                 }
                 //showSymbolCall(result.rows);
                 }*/
            },
            "onPageChange": function(){
                $("#img").show();
            }
        });

        function addMzInfo() {
            $("#addModalLabel").text("名址新增");
            $("#addModal").modal('show');
            $("#type").attr("disabled", false);
            // 当用户行政区划权限到了社区级则需要初始化坐标字段

            // 初始化表单
            //initAddrForm(1);
        };

        $("#addMzInfo").click(function() {
            $("#modalType").val("add");
            addMzInfo();
        });

        $("#updateMzInfo").click(function() {
            $("#modalType").val("update");
            var rows = $("#addrTable").bootstrapTable("getSelections");
            if(rows instanceof jQuery){
                bootstrapDialog("warning", "请选择一条信息!").open();
                return false;
            };
            if(!rows|| ($.isArray(rows)&& rows["length"] ==0)){
                bootstrapDialog("warning", "请选择一条信息!").open();
                return false;
            };

            var $id = rows[0]["id"];
            if(!$id){
                bootstrapDialog("error", "获取信息失败,请联系系统管理员!").open();
                return false;
            };
            if($id){
                $.get("rest/address/getById?id="+$id+"").done(function(data){
                    data = JSON.parse(data)["content"];
                    $("#address").val(data["address"]);
                    $("#shape").val(data["x"]+","+data["y"]);
                    $("#mz_ID").val($id);
                    $("#typeID_ld").val(data["type"]);
                    var $level = data["level"],
                    $li = $("li[data-value="+$level+"]", "#levelDropdownUl");
                    $li["length"]&& ($("#levelDropdownBtn span.filter-option.pull-left").text($li.attr("data-text")));
                    $("#levelID_ld").val($level);
                    $("#adcodeID_ld").val(data["adcode"]);
                    $.get("rest/address/getSinglePoiType?typeVlaue="+data["type"]+"", function(result){
                        console.log(result);
                        $("span.filter-option.pull-left").text(result["content"]);
                    });
                });
            };
            $("#addModal").modal('show');
            var typeId = rows[0]["type"];
        });

        $("#deleteInfo").on("click", function(){
            //$("#modalType").val("edit");
            var rows = $("#addrTable").bootstrapTable("getSelections");
            if(rows instanceof jQuery){
                bootstrapDialog("warning", "请选择一条信息!").open();
                return false;
            };
            if(!rows|| ($.isArray(rows)&& rows["length"] ==0)){
                bootstrapDialog("warning", "请选择一条信息!").open();
                return false;
            };
            var $id = rows[0]["id"];
            if($id){
                $.get("rest/address/deleteById?id="+$id, function(data){
                    if(data&& JSON.parse(data)["status"] == "success"){
                        bootstrapDialog("success", "删除成功!").open();
                        $("#addrTable").bootstrapTable("refresh");
                    }
                })
            }
        });

        $("#mz_smt").on("click", function(){
            var operType = $("#modalType").val();
            var $type = $("#typeID_ld").val();
            var $level = $("#levelID_ld").val();
            var $shape = $("#shape").val();
            var $address = $("#address").val();
            var $adcode = $("#adcodeID_ld").val();
            if(!$type){
                $("#typeCode_warn").show();
                return false;
            };
            if(!$level){
                $("#levelId_warn").show();
                return false;
            };
            if(!$shape){
                $("#shape_warn").show();
                return false;
            };
            if(!$address){
                $("#address_warn").show();
                return false;
            };
            var $x = $shape.split(",")[0], $y = $shape.split(",")[1];
            if(operType == "add"){
                $.ajax({
                    "type": "post",
                    "url": "rest/address/save",
                    "dataType": "json",
                    "contentType": "application/json;charset=utf-8",
                    "cache": false,
                    "data": JSON.stringify({"address": $address, "type": $type, "level": $level, "x": $x, "y": $y, "adcode": "440402"})
                }).done(function(data){
                        if(data&& data["status"] == "success"){

                            $("#addModal").modal('hide');bootstrapDialog("success", "添加成功!").open();
                            $("#addrTable").bootstrapTable("refresh");
                        };
                });
            }else if( operType == "update"){
                $.ajax({
                    "type": "post",
                    "url": "rest/address/update",
                    "dataType": "json",
                    "contentType": "application/json;charset=utf-8",
                    "cache": false,
                    "data": JSON.stringify({"id": $("#mz_ID").val(),"address": $address, "type": $type, "level": $level, "x": $x, "y": $y, "adcode": $adcode})
                }).done(function(data){
                    if(data&& data["status"] == "success"){
                        bootstrapDialog("success", "修改成功!").open();
                        $("#addrTable").bootstrapTable("refresh");
                        $("#addModal").modal('hide');
                    };
                });
            }else{

            }
        });
        draw.on('drawend',function(evt){
            var feature = evt.feature;
            var featureManager = new FeatureManager(map, vector);
            featureManager.addFeatures(feature);
            var point = ol.extent.getCenter(feature.getGeometry().getExtent());// 中心点坐标
            $.get("rest/address/getAdCode?x="+point[0]+"&y="+point[1]+"", function(data){
                if(data["status"] === "success"){
                    var countyName = data["content"]["CountyName"];
                    $("#addressGi, #address").val(countyName);
                }
            });
            $("#shape").val(point.join(","));
            draw.setActive(0);
            $("#addModal").modal("show");
        });
});

    function timeFormatter(value, row, index){
        if(!
                isBlank(value)){
            return new Date(value.time).Format("yyyy-MM-dd hh:mm:ss");
        } else{
            return '';
        }
    }

    function dateFormatter(value, row, index){
        if(!isBlank(value)){
            return
            new Date(value.time).Format("yyyy-MM-dd");
        }else{
            return '';
        }
    }

    //设置行序号格式
    function indexFormatter(value, row, index) {
        return index + 1;
    };
</script>
</html>