<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>名址审批</title>
    <link href="css/index.css" rel="stylesheet">
    <link href="css/ld.css" rel="stylesheet">
    <link href="css/font.css" rel="stylesheet">
    <link href="css/bootstrap-select.min.css" rel="stylesheet">
    <link href="css/bootstrap-dialog.min.css" rel="stylesheet">
    <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">
</head>
<body>
<div class="div_right" id="c_right_all">
    <h3 class="tt_sj m_t_16">名址审批</h3>
    <div class="form-inline" style="margin:0px 30px;height:45px">
        <!--<div class="form-group">
            <label>镇街:</label> <div class="btn-group bootstrap-select" style="width: 100px;"><button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="region" title="全区"><span class="filter-option pull-left">全区</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open"><ul class="dropdown-menu inner" role="menu"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全区</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="1"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">大沥镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="2"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">丹灶镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="3"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">桂城街道</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="4"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">九江镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="5"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">里水镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="6"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">狮山镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="7"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">西樵镇</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div><select id="region" class="selectpicker" data-width="100px" tabindex="-98"><option value="">全区</option><option value="440605125">大沥镇</option><option value="440605123">丹灶镇</option><option value="440605001">桂城街道</option><option value="440605121">九江镇</option><option value="440605126">里水镇</option><option value="440605124">狮山镇</option><option value="440605122">西樵镇</option></select></div>
        </div>
        <div class="form-group">
            <label>社区:</label> <div class="btn-group bootstrap-select" style="width: 100px;"><button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="cmbArea" title="全部"><span class="filter-option pull-left">全部</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open" style="max-height: 478.333px; overflow: hidden; min-height: 0px;"><ul class="dropdown-menu inner" role="menu" style="max-height: 468.333px; overflow-y: auto; min-height: 0px;"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全部</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div><select id="cmbArea" class="selectpicker" data-width="100px" tabindex="-98"><option value="">全部</option></select></div>
        </div>
        <div class="form-group">
            <label>类型:</label> <div class="btn-group bootstrap-select" style="width: 100px;"><button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="schType" title="全部"><span class="filter-option pull-left">全部</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open" style="max-height: 478.333px; overflow: hidden; min-height: 84px;"><ul class="dropdown-menu inner" role="menu" style="max-height: 468.333px; overflow-y: auto; min-height: 74px;"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全部</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="1"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">地址</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="2"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">地名</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="3"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">房名房址</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div><select id="schType" class="selectpicker" data-width="100px" tabindex="-98"><option value="">全部</option><option value="2">地址</option><option value="1">地名</option><option value="3">房名房址</option></select></div>
        </div>-->
        <div class="form-group">
            <label>审批:</label> <div class="btn-group bootstrap-select" style="width: 100px;"><button type="button" class="btn dropdown-toggle btn-default" data-toggle="dropdown" data-id="schApproval" title="全部"><span class="filter-option pull-left">全部</span>&nbsp;<span class="bs-caret"><span class="caret"></span></span></button><div class="dropdown-menu open" style="max-height: 478.333px; overflow: hidden; min-height: 84px;"><ul class="dropdown-menu inner" role="menu" style="max-height: 468.333px; overflow-y: auto; min-height: 74px;"><li data-original-index="0" class="selected"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">全部</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="1"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">未发布</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="2"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">已发布</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li><li data-original-index="3"><a tabindex="0" class="" style="" data-tokens="null"><span class="text">被驳回</span><span class="glyphicon glyphicon-ok check-mark"></span></a></li></ul></div><select id="schApproval" class="selectpicker" data-width="100px" tabindex="-98">
            <option value="">全部</option>
            <option value="0">未发布</option>
            <option value="1">已发布</option>
            <option value="3">被驳回</option>
        </select></div>
        </div>

        <div class="form-group">
            <label>名址:</label> <input type="text" class="form-control" id="name" style="width: 200px" placeholder="可输入名称、地址">
        </div>
    </div>
    <div class="form-inline" style="margin:0px 30px;height:45px">
        <div class="form-group">
            <label>操作员:</label> <input type="text" class="form-control" id="operUser" style="width: 110px">
        </div>
        <div class="form-group">
            <label>起始时间:</label>
            <div class="input-group date form_datetime" data-date-format="yyyy-mm-dd" data-link-field="startdate" data-link-format="yyyy-mm-dd" style="width:260px;">
                <input class="form-control" size="16" type="text" name="btime" placeholder="" id="btime"> <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span> <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
            </div>
        </div>
        <div class="form-group">
            <label>结束时间:</label>
            <div class="input-group date form_datetime" data-date-format="yyyy-mm-dd" data-link-field="enddate" data-link-format="yyyy-mm-dd" style="width:260px;">
                <input class="form-control" size="16" type="text" name="etime" placeholder="" id="etime"> <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span> <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
            </div>
        </div>
        <button type="button" class="btn btn-primary" id="addr_sch">查询</button>
    </div>
    <input type="hidden" id="shenpi_id" />
    <div style="margin:10px" id="addrTable_div">
        <div class="bootstrap-table"><div class="fixed-table-toolbar"></div><div class="fixed-table-container" style="padding-bottom: 0px;"><div class="fixed-table-header" style="display: none;"><table></table></div><div class="fixed-table-body"><div class="fixed-table-loading" style="top: 40px;">正在努力地加载数据中，请稍候……</div>
            <table id="shenpiTable" data-locale="zh-CN" data-cache="false" data-click-to-select="true" data-single-select="true" class="table">
                <thead>
                <tr>
                    <!--<th data-field="state" data-checkbox="true" data-cell-style="hideCell" data-visible="true"></th>-->
                    <th data-align='center' data-formatter="indexFormatter" data-width="10%">序号</th>
                    <th data-field="addrName" data-align='center' data-width="30%">地址</th>
                    <th data-field="createDate" data-align='center' data-width="10%"  data-formatter="dateFormatter" >时间</th>
                    <th data-align='center' data-width="10%" data-formatter="oper_bstformat" >操作</th>
                </tr>
                </thead>
            </table>
        </div>
            <div class="fixed-table-footer" style="display: none;">
                <table><tbody><tr></tr></tbody></table></div>
             </div>
        </div>
    </div>
</div>
<div class="modal fade" id="moreModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" style="display: none;">
    <div class="modal-dialog" style="height:1000px">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="addModalLabel">详情</h4>
            </div>
            <div class="modal-body" style="height: 560px; overflow-y: auto;">
                <div class="div_table">
                    <table id="hm-EditTbl" class="table table-bordered tab_1" style="text-align: left;">
                        <thead>
                        <tr>
                            <th style="width:200px;">属性名</th>
                            <th style="width:300px;" id="_head_new">属性值</th>
                            <th style="width: 300px; display: none;" id="_head_record">属性值(修改前)</th>
                        </tr>
                        </thead>
                        <tbody id="chakan">
                        <!--<tr>
                            <td>详细地址</td>
                            <td id="address"></td>
                            <td id="address_record" style="display: none;"></td>
                        </tr>-->
                        <tr>
                            <td>审核状态</td>
                            <td id="status"></td>
                            <td id="status_record" style="display: none;"></td>
                        </tr>
                        <tr>
                            <td>创建时间</td>
                            <td id="createDate"></td>
                            <td id="createDate_record" style="display: none;"></td>
                        </tr>
                        <tr>
                            <td>修改时间</td>
                            <td id="updateDate"></td>
                            <td id="updateDate_record" style="display: none;"></td>
                        </tr>
                        </tbody>
                    </table>
                    <table id="hm-EditTb2" class="table table-bordered tab_1" style="text-align: left;">
                        <thead>
                            <tr>
                                <th style="width:200px;">属性名</th>
                                <th style="width:300px;" id="_head_new_dw">属性值</th>
                                <th style="width:200px; display: none;" class="ld_ineed">属性名</th>
                                <th style="width: 300px; display: none;" id="_head_record_dw" class="ld_ineed">属性值(修改后)</th>
                            </tr>
                        </thead>
                        <tbody id="chakan_dw">
                            <tr>
                                <td>详细地址</td>
                                <td id="address_dw"></td>
                                <td style="display: none;" class="ld_ineed">详细地址</td>
                                <td id="address_record_dw" style="display: none;" class="ld_ineed"></td>
                            </tr>
                            <tr>
                                <td>坐标</td>
                                <td id="geometry_dw"></td>
                                <td style="display: none;"  class="ld_ineed">坐标</td>
                                <td id="geometry_record_dw" style="display: none;"  class="ld_ineed"></td>
                            </tr>
                            <tr>
                                <td>类别</td>
                                <td id="type_dw"></td>
                                <td style="display: none;"  class="ld_ineed">类别</td>
                                <td id="type_record_dw" style="display: none;"  class="ld_ineed"></td>
                            </tr>
                            <tr>
                                <td>行政区划</td>
                                <td id="adcode_dw"></td>
                                <td style="display: none;"  class="ld_ineed">类别</td>
                                <td id="adcode_record_dw" style="display: none;"  class="ld_ineed"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="div_map" style="height: 240px;"></div>
            </div>
            <div class="modal-footer">
                <button id="ld_agreed" type="button" class="btn btn-success">通过</button>
                <button id="ld_aject" type="button" class="btn btn-danger">拒绝</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<script src="js/bootstrap-table.js"></script>
<script src="js/bootstrap-dialog.js"></script>
<script src="js/ldmz.dialog.js"></script>
<script src="js/bootstrap-datetimepicker.min.js"></script>
<script src="js/map/styleManager.js"></script>
<script src="js/map/featureManager.js"></script>
<script src="js/map/MapView.js"></script>
<script>
    Date.prototype.Format = function(fmt) { //author: meizz
        var o = {
            "M+" : this.getMonth() + 1, //月份
            "d+" : this.getDate(), //日
            "h+" : this.getHours(), //小时
            "m+" : this.getMinutes(), //分
            "s+" : this.getSeconds(), //秒
            "q+" : Math.floor((this.getMonth() + 3) / 3), //季度
            "S" : this.getMilliseconds()
            //毫秒
        };
        if (/(y+)/.test(fmt))
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for ( var k in o)
            if (new RegExp("(" + k + ")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };

    $(document).ready(function(){
        $('div.form_datetime').datetimepicker({
            format: "yyyy-mm-dd hh:ii:ss",
            language:  'zh-CN',
            weekStart: 1,
            todayBtn:  1,
            autoclose: 1,
            todayHighlight: 1,
            startView: 2,
            minView: 0,
            forceParse: 0,
            pickerPosition: "bottom-left"
        });
        /*$("input:checkbox.ld_mijit", "#hm-EditTb2").on("click", function(){
            var $this = $(this), $tr = $this.closest("tr"), isCheck = $this.prop("checked");
            isCheck? $tr.addClass("ld-selected"): $tr.removeClass("ld-selected");
        });*/
        $(document).on("click", "#ld_agreed", function(){
            var $id = $("#shenpi_id").val();
            var isBefore = $("td.ld_ineed, th.ld_ineed", "#hm-EditTb2").is(":visible");
            var $lateStr = isBefore? JSON.stringify({"adcode": $("adcode_dw").text(), "type": $("type_dw").text(), "address": $("#address_dw").text(), "x": $("#geometry_dw").text().split(",")[0], "y": $("#geometry_dw").text().split(",")[1]}):
                                JSON.stringify({"adcode": $("adcode_record_dw").text(), "type": $("type_record_dw").text(), "address": $("#address_record_dw").text(), "x": $("#geometry_record_dw").text().split(",")[0], "y": $("#geometry_record_dw").text().split(",")[1]});
                //var $lateStr = isBefore? "{\\\"adcode\\\": \\\""+$("#adcode_dw").text()+"\\\", \\\"type\\\": \\\""+$("#type_dw").text()+"\\\", \\\"address\\\": \\\""+$("#address_dw").text()+"\\\", \\\"x\\\": \\\""+$("#geometry_dw").text().split(",")[0]+"\\\", \\\"y\\\": \\\""+$("#geometry_dw").text().split(",")[1]+"\\\"}":
            //"{\\\"adcode\\\": \\\""+$("#adcode_record_dw").text()+"\\\", \\\"type\\\": \\\""+$("#type_record_dw").text()+"\\\", \\\"address\\\": \\\""+$("#address_record_dw").text()+"\\\", \\\"x\\\": \\\""+$("#geometry_record_dw").text().split(",")[0]+"\\\", \\\"y\\\": \\\""+$("#geometry_record_dw").text().split(",")[1]+"\\\"}";
            //JSON.stringify({"adcode": $("adcode_record_dw").val(), "type": $("type_record_dw").val(), "address": $("#address_record_dw").val(), "x": $("#geometry_record_dw").val().split(",")[0], "y": $("#geometry_record_dw").val().split(",")[1]});

            var params = isBefore? {"dateBefore": $lateStr, "dateAfter": ""}: {"dateBefore": "", "dateAfter": $lateStr};
            params["id"] = $id;
            //params["type"] = $type;
            params["status"] = 0;
            $.ajax({
                "type": "post",
                "url": "rest/addrApproval/update",
                "dataType": "json",
                "contentType": "application/json;charset=utf-8",
                "cache": false,
                "data": JSON.stringify(params)
            }).done(function(data){
                if(data&& data["status"] == "success"){
                    bootstrapDialog("success", "审批成功!").open();
                    $("#moreModal").modal('hide');
                }else{
                    bootstrapDialog("error", "审批失败!错误信息:"+data["message"]).open();
                }
            });
        }).on("click", "#ld_aject", function(){
            var $id = $("#shenpi_id").val();
            var isBefore = $("td.ld_ineed, th.ld_ineed", "#hm-EditTb2").is(":visible");
            var $lateStr = isBefore? JSON.stringify({"adcode": $("adcode_dw").text(), "type": $("type_dw").text(), "address": $("#address_dw").text(), "x": $("#geometry_dw").text().split(",")[0], "y": $("#geometry_dw").text().split(",")[1]}):
                JSON.stringify({"adcode": $("adcode_record_dw").text(), "type": $("type_record_dw").text(), "address": $("#address_record_dw").text(), "x": $("#geometry_record_dw").text().split(",")[0], "y": $("#geometry_record_dw").text().split(",")[1]});
            var params = isBefore? {"date_before": $lateStr, "date_after": ""}: {"date_before": "", "date_after": $lateStr};
            params["id"] = $id;
            //params["type"] = $type;
            params["status"] = 1;
            $.ajax({
                "type": "post",
                "url": "rest/address/update",
                "dataType": "json",
                "contentType": "application/json;charset=utf-8",
                "cache": false,
                "data": JSON.stringify(params)
            }).done(function(data){
                if(data&& data["status"] == "success"){
                    bootstrapDialog("success", "审批成功!").open();
                    $("#moreModal").modal('hide');
                }else{
                    bootstrapDialog("error", "审批失败!错误信息:"+data["message"]).open();
                };
            });

        });
        $("#shenpiTable").bootstrapTable({
            "url": "rest/addrApproval/getDataList",
            "method": "post",
            pageSize: 10,
            //"dataKey": "rows",
            "silent": false,
            pagination: true,
            "singleSelect": true,
            "clickToSelect": true,
            "sidePagination": "server",
            "queryParams": function (bstparams) {
                var params = [];
                params.push({pageSize:10,pageNum: this.pageNumber});
                return params;
            },
            "responseHandler": function(data){
                return {"list": data["content"]["list"], "total": data["content"]["total"]};
            },
            "onLoadSuccess": function (result) {  //加载成功时
                console.log(result);
                $("div.fixed-table-loading").hide();
                $("#shenpiTable").on("click", "tr button.oper_tab_btn", function(){
                    var $id = $(this).attr("data_id"),
                        map, vector;
                    $("#moreModal").modal("show");
                    $("#shenpi_id").val($id);
                    $.get("rest/addrApproval/getById?id="+ $id).done(function(data){
                        data = JSON.parse(data);
                        var content = data["content"], dateBefore = JSON.parse(content["dateBefore"]),
                            dateAfter,
                            operate = content["operate"];

                        $("td.ld_ineed, th.ld_ineed", "#hm-EditTb2").hide();
                        $("#address_dw").text(dateBefore["address"]);
                        $("#geometry_dw").text(( dateBefore.x|| "") + ','+ (dateBefore.y|| ""));
                        $("#type_dw").text(dateBefore["type"]);
                        $("#adcode_dw").text(dateBefore["adcode"]);
                        $("#status").text(content["status"] === 0? "审批通过": content["status"] === 1? "审批不通过": content["status"] === 2? "待审批": "");
                        $("#createDate").text(content["createDate"]);
                        $("#updateDate").text(content["updateDate"]);
                        if(operate === "update"){
                            dateAfter = JSON.parse(content["dateAfter"]);
                            $("#address_record_dw").text(dateAfter["address"]);
                            $("#geometry_record_dw").text(( dateAfter.x|| "") + ','+ (dateAfter.y|| ""));
                            $("#type_record_dw").text(dateAfter["type"]);
                            $("#adcode_record_dw").text(dateAfter["adcode"]);
                            $("td.ld_ineed, th.ld_ineed", "#hm-EditTb2").show();
                        };
                        setTimeout(function(){
                            !baseMap.map&& baseMap.initMap({"el": "div_map"});
                            var feature1 = new ol.Feature({
                                'geometry': new ol.geom.Point(
                                    [dateBefore["x"], dateBefore["y"]])
                            });
                            var extent;
                            var ext = feature1.getGeometry().getExtent();
                            map = baseMap.map; vector = baseMap.vector;
                            if (extent) {
                                ol.extent.extend(extent, ext);
                            } else {
                                extent = ext;
                            };
                            feature1.setStyle(poiSvgStyle({value: "" }));
                            if (extent) {
                                map.getView().fit(extent, map.getSize());
                            };
                            var featureManager = new FeatureManager(map, vector);
                            featureManager.addFeatures([feature1]);
                            if(operate === "update"){
                                var feature2 = new ol.Feature({
                                    'geometry': new ol.geom.Point(
                                        [dateAfter["x"], dateAfter["y"]])
                                });
                                feature2.setStyle(poiSvgStyle({value: "", on: true}));
                                featureManager.addFeatures([feature2]);
                            };
                        }, 400);
                    });
                });
            },
            "onPageChange": function(){

            }
        });
    });

    function indexFormatter(value, row, index) {
        return index + 1;
    };
    function dateFormatter(value, row, index){
        return value? new Date(value).Format("yyyy-MM-dd hh:mm:ss"): "";
    };
    function oper_bstformat(value, row, index){
        return "<button type=\"button\" class=\"oper_tab_btn btn btn-default\" data_id='"+row["id"]+"') >审批</button>";
    };
</script>
</body>
</html>